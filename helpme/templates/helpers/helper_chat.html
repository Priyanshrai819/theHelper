<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with User - theHelpers</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 z-10 flex-shrink-0">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center space-x-4">
            <a href="{% url 'helpers:helper_dashboard' %}" class="flex items-center space-x-2 text-gray-600 hover:text-blue-500 transition-colors">
              <i class="ri-arrow-left-line"></i>
              <span class="text-sm font-medium">Back to Dashboard</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 max-w-6xl w-full mx-auto py-8 px-4 flex flex-col min-h-0">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 h-full">
            <!-- User Profile Card -->
            <div class="md:col-span-1 hidden md:block">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full overflow-hidden mb-4 bg-blue-100 flex items-center justify-center">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" class="w-full h-full object-cover">
                            {% else %}
                                <span class="text-blue-600 text-3xl font-bold">{{ user.fname|first|upper }}{{ user.lname|first|upper }}</span>
                            {% endif %}
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">{{ user.fname }} {{ user.lname }}</h2>
                        <p class="text-sm text-gray-500">Requester for "{{ request.get_service_category_display }}"</p>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="md:col-span-2 flex flex-col bg-white rounded-lg shadow h-full overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center md:hidden">
                        <span class="text-blue-600 font-bold">{{ user.fname|first|upper }}</span>
                    </div>
                    <h3 class="font-semibold text-gray-800">Chat with {{ user.fname }}</h3>
                </div>
                
                <!-- Chat Window -->
                <div id="chat-window" class="flex-1 p-6 space-y-4 overflow-y-auto bg-white">
                    <!-- Messages will be loaded here via AJAX -->
                    <div class="text-center text-xs text-gray-400 my-4">Chat started for {{ request.get_service_category_display }}</div>
                </div>
                
                <!-- Input Area -->
                <div class="p-4 border-t bg-gray-50">
                    <form id="chat-form" class="flex items-center space-x-3">
                        {% csrf_token %}
                        <input type="text" id="message-input" class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Type your message..." autocomplete="off">
                        <button type="submit" class="bg-blue-500 text-white rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0 hover:bg-blue-600 transition-colors">
                            <i class="ri-send-plane-fill text-lg"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatWindow = document.getElementById('chat-window');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            
            // Django URL tags ensure we hit the correct helper endpoints
            const fetchUrl = "{% url 'helpers:helper_get_chat_messages' request.id %}";
            const sendUrl = "{% url 'helpers:helper_send_chat_message' request.id %}";

            let lastMessageCount = 0;

            function scrollToBottom() {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function renderMessages(messages) {
                const introText = `<div class="text-center text-xs text-gray-400 my-4">Chat started for {{ request.get_service_category_display }}</div>`;
                let html = introText;
                
                messages.forEach(msg => {
                    if (msg.is_me) {
                        // My message (Helper) - Right side, Green/Secondary color
                        html += `
                            <div class="flex justify-end">
                                <div class="bg-green-500 text-white rounded-2xl rounded-tr-sm px-4 py-2 max-w-[75%] shadow-sm">
                                    <p class="text-sm">${msg.text}</p>
                                    <span class="text-[10px] text-green-100 flex justify-end mt-1">${msg.time}</span>
                                </div>
                            </div>`;
                    } else {
                        // Their message (User) - Left side, Gray
                        html += `
                            <div class="flex justify-start">
                                <div class="bg-gray-100 text-gray-800 rounded-2xl rounded-tl-sm px-4 py-2 max-w-[75%] shadow-sm">
                                    <p class="text-sm">${msg.text}</p>
                                    <span class="text-[10px] text-gray-500 mt-1">${msg.time}</span>
                                </div>
                            </div>`;
                    }
                });
                chatWindow.innerHTML = html;
            }

            async function fetchMessages() {
                try {
                    const response = await fetch(fetchUrl);
                    const data = await response.json();
                    
                    if (data.messages && data.messages.length > lastMessageCount) {
                        renderMessages(data.messages);
                        lastMessageCount = data.messages.length;
                        scrollToBottom();
                    }
                } catch (error) {
                    console.error("Error fetching messages:", error);
                }
            }

            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message) return;

                messageInput.value = ''; // Clear instantly for better UX

                const formData = new FormData();
                formData.append('message', message);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                try {
                    await fetch(sendUrl, {
                        method: 'POST',
                        body: formData
                    });
                    fetchMessages(); // Fetch messages instantly after sending
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            });

            // Fetch messages on page load and then every 3 seconds
            fetchMessages();
            setInterval(fetchMessages, 3000);
        });
    </script>
</body>
</html>